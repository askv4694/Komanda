---
title: "Hipotezių testas"
author: "Asta Kvedaraitė & Marius Survila"
date: "5/18/2020"
output: html_document
---

```{r echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  error = TRUE,
  echo = FALSE 
)
```

# Lyginamos grupės: sveiki/sergantys ir jų amžius.
```{r}
sample <- read.csv("../output/correctedSample.csv")
age <- sample$age
alzheimer <- sample$sample
test <- t.test(age ~ alzheimer)
```
Norint nustatyti sveikų ir sergančių amžiaus vidurkį, buvo atliktas T testas dviem nepriklausomoms grupėms.
Sveikų žmonių grupės amžiaus vidurkis yra `r test$estimate[[2]]`, o sergančiųjų ažmiaus vidurkis = `r test$estimate[[1]]`.
P-reikšmė = `r test$p.value`, `r test$statistic[[1]]`.

```{r}
plot(sample$age~ sample$sample, main= "Sveikų ir sergančių amžiaus pasiskirstymas", xlab = NA, ylab ="Age")

```


```{r}
if (!require("matrixTests")) install.packages("matrixTests")
if (!require("reshape2")) install.packages("reshape2")
library("matrixTests")
library(ggplot2)
library(grid)
library(gridExtra)
library(reshape2)
data <- readRDS("../output/betab.rds")

anno <- readRDS("../output/annotation.rds")
as.data.frame(anno)

names <- sample$sample_id[sample$sample == "Control"]
con <- data[,names]
alz <- data[ ,-c(names)]

ttest <- matrixTests::row_t_welch(alz, con)
ord <- ttest[order(ttest$pvalue),]
ord[1:5,]
names <- rownames(ord[1:5,])
df <- t(data[names,])
df <- as.data.frame(df)
library(data.table)
df <- setDT(df, keep.rownames = TRUE)[]
colnames(df)[1] <- "Sample_names"
df$sample <- sample$sample
df


```




```{r}

ggplot(df, aes(x = df$Sample_names, y = df$cg05810363, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,2])) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas") + 
   geom_point()

```


```{r}
ggplot(df, aes(x = df$Sample_names, y = df$cg13076843, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,3])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg12163800, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,4])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg11823178, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,5])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg03169557, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,6])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()

```

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
minimum <- min(df[,2:6])
maximum <- max(df[,2:6])
```
Aukščiau, grafike pavaizduotos 5 metilintos eilutės, turinčios didžiausius skirtumus, kurie buvo gauti naudojant T test kiekvienai eilutei. Mūsų reikšmės - mažiausia(`r minimum`) ir didžiausia(`r maximum`) parodo, jog grafike esančios reikšmės yra teisingai nurodytame rėžyje.


```{r}

getParray <- function(alpha){
  ttest <- matrixTests::row_t_welch(alz, con, conf.level = 1 - alpha)
  names <- rownames(ttest)[ttest$pvalue < alpha]
  return(names)
}
#con ir alz <- dataframes 

con1 <- getParray(0.1)
con2 <- getParray(0.05)
con3 <- getParray(0.01)
length(con1)

afterp1 <- data[con1,]
afterp2 <- data[con2,]
afterp3 <- data[con3,]

test <- matrixTests::row_t_welch(alz, con,conf.level = 0.05)
p <- p.adjust(test$pvalue, method = "fdr")
fdrCon <- rownames(test)[p < 0.05]
fdrCon <- data[fdrCon,]
p <- p.adjust(test$pvalue, method = "bonferroni")
boncon <- rownames(test)[p < 0.05]
boncon <- data[boncon,]

values <- data.frame("alfa" = c(0.1, 0.05, 0.01, "fdr", "bonferonni"), 
                     "Eilutės" = c(length(con1), length(con2), length(con3),
                                   length(fdrCon), length(boncon)))

knitr::kable(values)

```


```{r}
hist(boncon, col = rgb(255,150,10,max = 255, alpha = 80),
     main = "Boneferroni histograma", xlab = "Reikšmės", ylab = "Dažnis")
```


```{r}

hg1 <- hist(afterp1, plot = FALSE) # Save first histogram data
hg2 <- hist(afterp2, plot = FALSE) # Save 2nd histogram data
hg3 <- hist(afterp3, plot = FALSE)
hgfdr <- hist(fdrCon, plot = FALSE)
hgbon <- hist (boncon, plot = FALSE)
```

```{r}
c1 <- rgb(255,255,0,max = 255, alpha = 80)
c2 <- rgb(255,192,203, max = 255, alpha = 80)
c3 <- rgb(0,255,128, max = 255, alpha = 80)
c4 <- rgb(0,10,255, max = 255, alpha = 80)
c5 <- rgb(255,10,0, max = 255, alpha = 80)

plot(hg1, col = c1, main = "Reikšmių dažniai, pagal skirtingas alfa reikšmes",
     xlab = "Reikšmės", ylab = "Dažnis")
plot(hg2, col = c2, add = TRUE) 
plot(hg3, col = c3, add = TRUE)
plot(hgfdr, col = c4, add = TRUE)
plot(hgbon, col = c5, add = TRUE)
legend("top", c("0.1", "0.05", "0.01", "FDR", "BONFERONNI"),
       fill=c(c1, c2, c3, c4, c5))
```


```{r}
if (!requireNamespace('BiocManager', quietly = TRUE))
    install.packages('BiocManager')
    BiocManager::install('EnhancedVolcano')
if (!require('Dplot')) install.packages('Dplot')
library(EnhancedVolcano)

plot(log(con$pvalue))
plot(con$pvalue)

```

```{r}
chrom <- as.data.frame(data[258,])
chrom
plot(-log(chrom))


```

```{r}
#con[] <- lapply(con, function(x) {
#    if(is.double(x)) as.numeric(as.character(x)) else as.character(x)
#})
#con[1:20,]
#EnhancedVolcano(con,
#    x = 'log2FoldChange',
#    y = 'pvalue')#

#volcanoPlot(con$pvalue)

```


