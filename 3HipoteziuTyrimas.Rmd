---
title: "Hipotezių testas"
author: "Asta Kvedaraitė & Marius Survila"
date: "5/18/2020"
output: html_document
---

```{r echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  error = TRUE,
  echo = FALSE 
)
```

# Lyginamos grupės: sveiki/sergantys ir jų amžius.
```{r}
sample <- read.csv("../output/correctedSample.csv")
age <- sample$age
alzheimer <- sample$sample
test <- t.test(age ~ alzheimer)
```
Norint nustatyti sveikų ir sergančių amžiaus vidurkį, buvo atliktas T testas dviem nepriklausomoms grupėms.
Sveikų žmonių grupės amžiaus vidurkis yra `r test$estimate[[2]]`, o sergančiųjų ažmiaus vidurkis = `r test$estimate[[1]]`.
P-reikšmė = `r test$p.value`, `r test$statistic[[1]]`.

```{r}
plot(sample$age~ sample$sample, main= "Sveikų ir sergančių amžiaus pasiskirstymas", xlab = NA, ylab ="Age")

```


```{r}
if (!require("matrixTests")) install.packages("matrixTests")
if (!require("reshape2")) install.packages("reshape2")
library("matrixTests")
library(ggplot2)
library(grid)
library(gridExtra)
library(reshape2)
data <- readRDS("../output/betab.rds")

anno <- readRDS("../output/annotation.rds")

names <- sample$sample_id[sample$sample == "Control"]
con <- data[,names]
alz <- data[ ,-c(names)]

library(data.table)
library(ggplot2)

ttest <- matrixTests::row_t_welch(alz, con)

ord <- ttest[order(ttest$pvalue),]

names <- rownames(ord[1:5,])
df <- t(data[names,])
df <- as.data.frame(df)

df <- setDT(df, keep.rownames = TRUE)[]
colnames(df)[1] <- "Sample_names"
df$sample <- sample$sample

minimum <- min(df[,2:6])
maximum <- max(df[,2:6])
```

```{r}

getplot<- function(names, array, compare, colname){
  df1 <- data.frame("Sample_names" = names, "array" = array, "sample" = compare)
  ggplot(df1, aes(x = Sample_names, y = array, color = factor(sample))) +
  ggtitle("Metilintos reikšmes", colname) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas") +
  scale_colour_discrete("Samples") +
  geom_point()
}

```
Žemiau, grafike pavaizduotos 5 metilintos eilutės, turinčios didžiausius skirtumus, kurie buvo gauti naudojant T test kiekvienai eilutei. Mūsų reikšmės - mažiausia(`r minimum`) ir didžiausia(`r maximum`) parodo, jog grafike esančios reikšmės yra teisingai nurodytame rėžyje.
```{r}
par(mfrow = c(3,2))
getplot(df$Sample_names, df$cg05810363, df$sample, colnames(df[,2]))
getplot(df$Sample_names, df$cg13076843, df$sample, colnames(df[,3]))
getplot(df$Sample_names, df$cg12163800, df$sample, colnames(df[,4]))
getplot(df$Sample_names, df$cg11823178, df$sample, colnames(df[,5]))
getplot(df$Sample_names, df$cg03169557, df$sample, colnames(df[,6]))
par(mfrow = c(1, 1))
```


```{r}
printParray<- function(ptest){
  getParray <- function(alpha){
    ptest <- ptest[ptest$pvalue < alpha,]
    return(ptest)
  }
  #con ir alz <- dataframes 
  
  afterp1 <<- getParray(0.1)
  afterp2 <<- getParray(0.05)
  afterp3 <<- getParray(0.01)
  
  
  p <- p.adjust(ptest$pvalue, method = "fdr")
  fdrCon <<- ttest[p < 0.05,]
  
  p <- p.adjust(ptest$pvalue, method = "bonferroni")
  boncon <<- ttest[p < 0.05,]
  
  values <- data.frame("alfa" = c(0.1, 0.05, 0.01, "fdr", "bonferroni"), 
                       "Eilutės" = c(nrow(afterp1), nrow(afterp2), nrow(afterp3),
                                     nrow(fdrCon), nrow(boncon)))
  
    return(values)
}
values <- printParray(ttest)
knitr::kable(values)

```


```{r}
hist(boncon$pvalue, col = rgb(255,150,10,max = 255, alpha = 80),
     main = "Bonferroni histograma", xlab = "Reikšmės", ylab = "Dažnis")
```


```{r}
gethistogram<- function(){
  hg1 <- hist(afterp1$pvalue, plot = FALSE) # Save first histogram data
  hg2 <- hist(afterp2$pvalue, plot = FALSE) # Save 2nd histogram data
  hg3 <- hist(afterp3$pvalue, plot = FALSE)
  hgfdr <- hist(fdrCon$pvalue, plot = FALSE)
  hgbon <- hist (boncon$pvalue, plot = FALSE)

  c1 <- rgb(255,255,0,max = 255, alpha = 80)
  c2 <- rgb(255,192,203, max = 255, alpha = 80)
  c3 <- rgb(0,255,128, max = 255, alpha = 80)
  c4 <- rgb(0,10,255, max = 255, alpha = 80)
  c5 <- rgb(255,10,0, max = 255, alpha = 80)

  plot(hg1, col = c1, main = "Reikšmių dažniai, pagal skirtingas alfa reikšmes",
       xlab = "Reikšmės", ylab = "Dažnis")
  plot(hg2, col = c2, add = TRUE) 
  plot(hg3, col = c3, add = TRUE)
  plot(hgfdr, col = c4, add = TRUE)
  plot(hgbon, col = c5, add = TRUE)
  legend("top", c("0.1", "0.05", "0.01", "FDR", "BONFERRONI"),
         fill=c(c1, c2, c3, c4, c5))
}


```

Žemiau pavaizduotas grafikas rodo, kad mažėjant \(\alpha\), mažėja reikšmių kiekis (p-reikšmės), kurios yra patikimos.
Tačiau po p reikšmių sulyginimo FDR ir Bonferroni metodais, dar labiau sumažėja patikimų p-reikšmių kiekis.
```{r}

gethistogram()
```

```{r}
if (!require("moduleColor")) install.packages("moduleColor")
library(moduleColor)

getvolcano <- function(){
  afterp1$col <- ifelse(afterp1$mean.diff > 0, 6, 2)
  afterp2$col <- ifelse(afterp2$mean.diff > 0, 6, 2)
  afterp3$col <- ifelse(afterp3$mean.diff > 0, 6, 2)
  fdrCon$col <- ifelse(fdrCon$mean.diff > 0, 6, 2)
  boncon$col <- ifelse(boncon$mean.diff > 0, 6, 2)
  plot(c(afterp1$mean.diff,afterp2$mean.diff,afterp3$mean.diff,fdrCon$mean.diff,boncon$mean.diff),
       c(-log(afterp1$pvalue),-log(afterp2$pvalue),-log(afterp3$pvalue),
         -log(fdrCon$pvalue),-log(boncon$pvalue) ), 
       col = labels2colors(c(afterp1$col, afterp2$col, afterp3$col, fdrCon$col, boncon$col)),
       xlab="mean difference", ylab="pvalues", main = "Volcano plot of pvalues")
  par(mfrow = c(1, 1))
}

```

Volcano plot(grafikas) naudojamas daugiausia statistikoje, norint nurodyti p-reikšmes ir atstumą nuo grafo ašies(0).
Jis padeda vizualiai identifikuoti genus, kurie turi didesnius atstumus nei kiti. Bioinformatikoje reikšmės
pavaizduotos nuo ašies į dešinę pusę yra genai, skatinantys procesus ar kitus atsakus. O į kairę -  genai, kurie
slopina procesus ar jo atsakus. O į viršų yra bilogiškai reikšmingi genai.

```{r}
getvolcano()

```

```{r}

getrelations <- function(ptest, chromosome, num){
  names <- rownames(anno)[anno$chr == chromosome]
  temp <- anno[names,]
  if (num == 0){chr <- ptest[names,]}
  else{
    chr <- ptest
  }
  
  chr$cpg <- temp$Relation_to_Island
  rm(temp)
  #"Island"  "S_Shore" "OpenSea" "N_Shore" "S_Shelf" "N_Shelf"
  for (i in 1 : nrow(chr)){
    if (chr$cpg[i] == "Island") chr$cpgnum[i] <- 4
    else if (chr$cpg[i] == "S_Shore") chr$cpgnum[i] <- 2
    else if (chr$cpg[i] == "OpenSea") chr$cpgnum[i] <- 1
    else if (chr$cpg[i] == "N_Shore") chr$cpgnum[i] <- 12
    else if (chr$cpg[i] == "S_Shelf") chr$cpgnum[i] <- 3
    else if (chr$cpg[i] == "N_Shelf") chr$cpgnum[i] <- 6
  }
  
  par(mar = c(2, 4, 4, 8),                                  # Specify par parameters
      xpd = TRUE)
  plot(-log(chr$pvalue), col = labels2colors(chr$cpgnum), pch = 19, main = chromosome, 
       xlab = "Pozicijos", ylab = "Reikšmės")
  
  legend("topright",inset = c(- 0.3, 0),legend= unique(chr$cpg), title = "Pagal CpG salas",
         fill = labels2colors(unique(chr$cpgnum)))
  
  par(xpd=TRUE)
}

```

Manhattan plot- yra grafikas, kuris parodo duomenis, kurie labiau išsiskiria iš kitų, p-reikšmėmis. Mažiausios p-reikšmės
tampa didžiausiomis pritaikant -log10.  

```{r}
getrelations(ttest, "chrY", 0)
```

Tiesinė regresija naudojant amžių ir būseną : serga ar neserga.
```{r}
df <- data.frame("name" =character(), "pvalue" =  numeric(),
                 "coef" = numeric(), stringsAsFactors = FALSE)
chromo <- rownames(anno)[anno$chr == "chr11"]

#for (i in 1:nrow(cdata)){
#    lm0 <- lm(data[i,] ~ sample$age)
#    lm1 <- lm(data[i,] ~ sample$age + sample$sample) 
#    anv <- anova(lm0, lm1)
#    df[i,] <- c(rownames(data)[i],anv$Pr[2],coef(lm1)[3])
#    cat(i, "\r")
#}

#saveRDS(df, "../output/chr11.rds")
df <- readRDS("../output/chr11.rds")
```

Pasirinkta 11 chromosoma, viso turi `r nrow(df)` eilučių, iš kurių atrinktos patikimos p-value reikšmės.
```{r}
printParray(df)

```

Visos reikšmės panašios, pagal atitinkamą \(\alpha\) slenkstį.
```{r}
gethistogram()

```
```{r}

df$col <- ifelse(df$coef > 0, 6, 2)
 plot(df$coef,-log(df$pvalue), 
       col = labels2colors(df$col),
       xlab="mean difference", ylab="pvalues", main = "Volcano plot of pvalues")
```

```{r}
getrelations(df, "chr11",1)

```
