---
title: "Hipotezių testas"
author: "Asta Kvedaraitė & Marius Survila"
date: "5/18/2020"
output: html_document
---

```{r echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  error = TRUE,
  echo = FALSE 
)
```

# Lyginamos grupės: sveiki/sergantys ir jų amžius.
```{r}
sample <- read.csv("../output/correctedSample.csv")
age <- sample$age
alzheimer <- sample$sample
test <- t.test(age ~ alzheimer)
```
Norint nustatyti sveikų ir sergančių amžiaus vidurkį, buvo atliktas T testas dviem nepriklausomoms grupėms.
Sveikų žmonių grupės amžiaus vidurkis yra `r test$estimate[[2]]`, o sergančiųjų ažmiaus vidurkis = `r test$estimate[[1]]`.
P-reikšmė = `r test$p.value`, `r test$statistic[[1]]`.

```{r}
plot(sample$age~ sample$sample, main= "Sveikų ir sergančių amžiaus pasiskirstymas", xlab = NA, ylab ="Age")

```


```{r}
if (!require("matrixTests")) install.packages("matrixTests")
if (!require("reshape2")) install.packages("reshape2")
library("matrixTests")
library(ggplot2)
library(grid)
library(gridExtra)
library(reshape2)
data <- readRDS("../output/betab.rds")

anno <- readRDS("../output/annotation.rds")
as.data.frame(anno)

names <- sample$sample_id[sample$sample == "Control"]
con <- data[,names]
alz <- data[ ,-c(names)]

ttest <- matrixTests::row_t_welch(alz, con)
ord <- ttest[order(ttest$pvalue),]
ord[1:5,]
names <- rownames(ord[1:5,])
df <- t(data[names,])
df <- as.data.frame(df)
library(data.table)
df <- setDT(df, keep.rownames = TRUE)[]
colnames(df)[1] <- "Sample_names"
df$sample <- sample$sample
df


```

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
minimum <- min(df[,2:6])
maximum <- max(df[,2:6])
```
Žemiau, grafike pavaizduotos 5 metilintos eilutės, turinčios didžiausius skirtumus, kurie buvo gauti naudojant T test kiekvienai eilutei. Mūsų reikšmės - mažiausia(`r minimum`) ir didžiausia(`r maximum`) parodo, jog grafike esančios reikšmės yra teisingai nurodytame rėžyje.

```{r}

ggplot(df, aes(x = df$Sample_names, y = df$cg05810363, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,2])) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas") + 
   geom_point()

```


```{r}
ggplot(df, aes(x = df$Sample_names, y = df$cg13076843, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,3])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg12163800, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,4])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg11823178, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,5])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()
ggplot(df, aes(x = df$Sample_names, y = df$cg03169557, color = factor(df$sample))) +
  ggtitle("Metilintos reikšmes", colnames(df[,6])) +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Pasiskirstymas")+
   geom_point()

```


```{r}

getParray <- function(alpha){
  ttest <- ttest[ttest$pvalue < alpha,]
  return(ttest)
}
#con ir alz <- dataframes 

afterp1 <- getParray(0.1)
afterp2 <- getParray(0.05)
afterp3 <- getParray(0.01)


p <- p.adjust(ttest$pvalue, method = "fdr")
fdrCon <- ttest[p < 0.05,]

p <- p.adjust(ttest$pvalue, method = "bonferroni")
boncon <- ttest[p < 0.05,]

values <- data.frame("alfa" = c(0.1, 0.05, 0.01, "fdr", "bonferroni"), 
                     "Eilutės" = c(nrow(afterp1), nrow(afterp2), nrow(afterp3),
                                   nrow(fdrCon), nrow(boncon)))

knitr::kable(values)
```


```{r}
hist(boncon$pvalue, col = rgb(255,150,10,max = 255, alpha = 80),
     main = "Bonferroni histograma", xlab = "Reikšmės", ylab = "Dažnis")
```


```{r}

hg1 <- hist(afterp1$pvalue, plot = FALSE) # Save first histogram data
hg2 <- hist(afterp2$pvalue, plot = FALSE) # Save 2nd histogram data
hg3 <- hist(afterp3$pvalue, plot = FALSE)
hgfdr <- hist(fdrCon$pvalue, plot = FALSE)
hgbon <- hist (boncon$pvalue, plot = FALSE)
```

```{r}
c1 <- rgb(255,255,0,max = 255, alpha = 80)
c2 <- rgb(255,192,203, max = 255, alpha = 80)
c3 <- rgb(0,255,128, max = 255, alpha = 80)
c4 <- rgb(0,10,255, max = 255, alpha = 80)
c5 <- rgb(255,10,0, max = 255, alpha = 80)

plot(hg1, col = c1, main = "Reikšmių dažniai, pagal skirtingas alfa reikšmes",
     xlab = "Reikšmės", ylab = "Dažnis")
plot(hg2, col = c2, add = TRUE) 
plot(hg3, col = c3, add = TRUE)
plot(hgfdr, col = c4, add = TRUE)
plot(hgbon, col = c5, add = TRUE)
legend("top", c("0.1", "0.05", "0.01", "FDR", "BONFERRONI"),
       fill=c(c1, c2, c3, c4, c5))
```


```{r}

par(mfrow = c(2,3))
plot(afterp1$mean.diff,-log(afterp1$pvalue))
plot(afterp2$mean.diff,-log(afterp2$pvalue))
plot(afterp3$mean.diff,-log(afterp3$pvalue))
plot(fdrCon$mean.diff,-log(fdrCon$pvalue))
plot(boncon$mean.diff,-log(boncon$pvalue))

par(mfrow = c(1, 1))
```

```{r}
if (!require("moduleColor")) install.packages("moduleColor")
library(moduleColor)
names <- rownames(anno)[anno$chr == "chrY"]
temp <- anno[names,]
chr <- ttest[names,]
chr$cpg <- temp$Relation_to_Island
rm(temp)
#"Island"  "S_Shore" "OpenSea" "N_Shore" "S_Shelf" "N_Shelf"
for (i in 1 : nrow(chr)){
  if (chr$cpg[i] == "Island") chr$cpgnum[i] <- 1
  else if (chr$cpg[i] == "S_Shore") chr$cpgnum[i] <- 2
  else if (chr$cpg[i] == "OpenSea") chr$cpgnum[i] <- 3
  else if (chr$cpg[i] == "N_Shore") chr$cpgnum[i] <- 4
  else if (chr$cpg[i] == "S_Shelf") chr$cpgnum[i] <- 5
  else if (chr$cpg[i] == "N_Shelf") chr$cpgnum[i] <- 6
}

```

```{r}
par(mar = c(2, 4, 4, 8),                                  # Specify par parameters
    xpd = TRUE)
plot(-log(chr$pvalue), col = labels2colors(chr$cpgnum), pch = 19, main = "Chromosoma Y", 
     xlab = "Pozicijos", ylab = "Reikšmės")

legend("topright",inset = c(- 0.3, 0),legend= unique(chr$cpg), title = "Pagal CpG salas",
       fill = labels2colors(unique(chr$cpgnum)))

par(xpd=TRUE)
```
```{r}
df <- data.frame("name" =character(), "pval" =  numeric(),
                 "coef" = numeric(), stringsAsFactors = FALSE)

for (i in 1:nrow(data)){
    lm0 <- lm(data[i,] ~ sample$age)
    lm1 <- lm(data[i,] ~ sample$age + sample$sample) 
    anv <- anova(lm0, lm1)
    df[i,] <- c(rownames(data)[i],anv$Pr[2],coef(lm1)[3])
    cat(i, "\r")
}
df

```
